<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poké-Talk!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>

<body>
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <h1><a class="navbar-brand" href="#">Poké-Talk!</a></h1>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse fw-bold" id="navbarNav">
                <ul class="navbar-nav ms-auto me-2 fs-3">
                    <li class="nav-item"><a class="nav-link" aria-current="page" href="/"> <i class="bi-house"></i> </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/talkroom.html"> <i class="bi-chat-left-text"></i>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/dblog.html"> <i class="bi-journals"></i> </a></li>
                    <li class="nav-item"><a class="nav-link" href="#"> <i class="bi-person-circle"></i> </a></li>
                    <li class="nav-item"><a class="nav-link" href="#"> <i class="bi-question-circle"></i> </a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section>
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-4">
                    <div class="container">
                        <div class="row text-center align-items-center">
                            <div class="col-5 col-lg-12"><img
                                    src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/shiny/25.png"
                                    width="auto" class="img-fluid" id="chara_img_selected"></div>
                            <div class="col-7 col-lg-12">
                                <div class="fs-2 fw-normal my-3" id="chara_name_selected">Pokemon</div>
                                <div class="m-1" id="chara_description_selected">はなつみポケモン / みどりいろ</div>
                                <div class="m-1" id="chara_flavor_selected">せつめい</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-8">
                    <div class="container my-5 ">
                        <div class="row p-2">

                            <div class="col-1">
                                <div class="pt-2" style="display: block; width: 150%;"><img
                                        src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png"
                                        style="width: 100%; height: 60px; object-position: 50% 50%; object-fit: cover;"
                                        class="img-fluid" id="chara_img_ico"></div>
                            </div>
                            <div class="col-9">
                                <div class="card my-2" style="border-radius: 10px;">
                                    <div class="card-body" id="question_card">
                                        きみの　しつもん
                                    </div>
                                </div>
                            </div>
                            <div class="col-2"></div>

                        </div>

                        <div class="row p-2">
                            <div class="col-2"></div>
                            <div class="col-9">
                                <div class="card my-2" style="border-radius: 10px;">
                                    <div class="card-body" id="answer_card">
                                        ポケモン　からの　へんじ
                                    </div>
                                </div>
                            </div>
                            <div class="col-1 pt-4">
                                <i class="bi-emoji-smile fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 100px; display: block;"></div>
    </section>

    <footer class="fixed-bottom">
        <div style="background-color: #ffffffee; box-shadow: inset #ffffff00;" class="pt-1 pb-3">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-0 col-lg-4 "></div>
                    <div class="col-11 col-lg-7 text-end p-3">
                        <textarea name="question_sentence" id="question_field" class="form-control px-4 py-3" rows="1"
                            placeholder="しつもんを　かいて　ポケモンに　しつもんしよう！" required
                            style="resize: none; border-radius: 10px;"></textarea>
                    </div>
                    <div class="col-1" id="send_btn">
                        <button type="button" class="btn btn-primary" style="border-radius: 50%;"><i
                                class="bi-send fs-3" id="send_icon"></i></button>
                    </div>
                </div>
            </div>
            <p class="text-center m-0">&copy; 2023 Mitrarashi3776 All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script charset="utf-8">
        const url_query = window.location.search.slice(1);
        const query_data = url_query.split('=');
        const character_num_selected = Number(query_data[1]);


        const ApiRoute_species = 'https://pokeapi.co/api/v2/pokemon-species/';
        const ApiRoute_img = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/shiny/"
        const ApiRoute_img_alt = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/"
        const ApiRoute_ico = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/"
        const ApiRoute_default = "https://pokeapi.co/api/v2/pokemon/"


        let character_flavor_selected = '';
        let character_name_selected = '';
        let character_genera_selected = '';
        let character_color_selected = '';

        console.log(character_num_selected);



        fetch(ApiRoute_species + character_num_selected + '/', {
            method: "GET"
        })
            .then(response => {
                return response.json();
            })
            .then(data1 => {
                console.log(data1);
                for (var i in data1['names']) {
                    // console.log(data1['names'][i]);
                    if (data1['names'][i]['language']['name'] == 'ja-Hrkt') {
                        //document.getElementById("dispTargetArea").innerHTML = data1['name'];
                        console.log(data1['names'][i]['name']);
                        character_name_selected = data1['names'][i]['name'];
                        document.getElementById('chara_name_selected').innerHTML = character_name_selected;
                    } else { }
                }
                for (var i in data1['flavor_text_entries']) {
                    // console.log(data1['names'][i]);
                    if (data1['flavor_text_entries'] == "") {
                        character_flavor_selected = '説明が見つかりませんでした。';
                        break;
                    }
                    if (data1['flavor_text_entries'][i]['language']['name'] == 'ja-Hrkt') {
                        //document.getElementById("dispTargetArea").innerHTML = data1['name'];
                        if (character_flavor_selected == null) {
                            character_flavor_selected = data1['flavor_text_entries'][i]['flavor_text'];
                            break;
                        } else {
                            character_flavor_selected = character_flavor_selected + '<br>' + data1['flavor_text_entries'][i]['flavor_text'];
                        }
                    } else { }
                }
                if (data1['flavor_text_entries'] != "" && character_flavor_selected == null) {
                    character_flavor_selected = '<div class="my-2 alart alart-info" role="alart" style="font-size: 0.8em">日本語の説明が見つかりませんでした。<br>英語で表示します。</div><div>' + data1['flavor_text_entries'][0]['flavor_text'] + '</div>';
                }
                document.getElementById('character_flavor_selected');
                console.log(character_flavor_selected);

                for (var i in data1['genera']) {
                    if (data1['genera'][i]['language']['name'] == 'ja-Hrkt') {
                        if (character_genera_selected == null) {
                            character_genera_selected = data1['genera'][i]['genus'];
                            break;
                        } else { }
                    } else { }
                }
                console.log(character_genera_selected);
                switch (data1['color']['name']) {
                    case 'black':
                        character_color_selected = 'くろいろ';
                        break;
                    case 'blue':
                        character_color_selected = 'あおいろ';
                        break;
                    case 'brown3':
                        character_color_selected = 'ちゃいろ';
                        break;
                    case 'gray':
                        character_color_selected = 'はいいろ';
                        break;
                    case 'green':
                        character_color_selected = 'みどりいろ';
                        break;
                    case 'pink':
                        character_color_selected = 'ももいろ';
                        break;
                    case 'purple':
                        character_color_selected = 'むらさきいろ';
                        break;
                    case 'red':
                        character_color_selected = 'あかいろ';
                        break;
                    case 'white':
                        character_color_selected = 'しろいろ';
                        break;
                    case 'yellow':
                        character_color_selected = 'きいろ';
                        break;
                    default:
                        character_color_selected = '';
                        console.log('Error!!');
                        break;
                }
                document.getElementById('chara_description_selected').innerHTML = character_genera_selected + ' / ' + character_color_selected;
                console.log(character_color_selected);


                document.getElementById('chara_img_selected').src = ApiRoute_img_alt + character_num_selected + '.png';
                document.getElementById('chara_img_ico').src = ApiRoute_ico + character_num_selected + '.png';



            })
            .finally(() => {
                // 取得完了をログに残す
                console.log("request complete!")
            });


        document.getElementById('send_btn').addEventListener('click', () => {
            console.log('Sned Message')
            document.getElementById('send_btn').disabled = true;
            document.getElementById('question_field').disabled = true;
            // document.getElementById('send_icon').classList.add("bi-send", "bi-send-x");
            // document.getElementById('send_btn').classList.replace("btn-primary", "btn-secondary");

            const postData = {
                "chara_num": character_num_selected,
                "character": character_name_selected + '（ポケモン）',
                "question_sentence": document.getElementById('question_field').value
            };

            document.getElementById('question_card').innerHTML = document.getElementById('question_field').value;
            document.getElementById('question_field').value = 'ポケモンに　きいて　います。　しばらく　おまち　ください。';

            fetch("answer", {
                method: "POST",
                headers: { "Content-Type": "application/json; charset=utf-8" },
                body: JSON.stringify(postData)
            })
                .then(response => {
                    // 回答データをjson形式で取得
                    return response.json();
                })
                .then(data => {
                    // テキストボックスに回答データを反映
                    document.getElementById('answer_card').innerHTML = data.answer;
                })
                .finally(() => {
                    // ボタンを元に戻す
                    document.getElementById('send_btn').disabled = false;
                    document.getElementById('question_field').disabled = false;
                    console.log("request complete!")
                });
        })
    </script>
</body>

</html>